<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Papeler√≠a Manager</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
    <style>
      :root {
        --primary-color: #2563eb; /* Blue 600 */
        --secondary-color: #3b82f6; /* Blue 500 */
        --background-color: #f8fafc; /* Slate 50 */
        --text-color: #1e293b; /* Slate 800 */
        --success-color: #10b981; /* Emerald 500 */
        --info-color: #60a5fa; /* Blue 400 */
        --warning-color: #f59e0b; /* Amber 500 */
        --danger-color: #ef4444; /* Red 500 */
        --border-color: #e2e8f0; /* Slate 200 */
        --card-bg: #ffffff; /* White */

        /* Consistent Button Styles */
         --btn-padding-y: 0.375rem;
         --btn-padding-x: 0.75rem;
         --btn-font-size: 1rem;
         --btn-border-radius: 0.25rem; /* Bootstrap default */
         --btn-transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
      }

      body {
        background-color: var(--background-color);
        color: var(--text-color);
        font-family: "Segoe UI", system-ui, sans-serif;
      }

      /* Using Bootstrap's .active class directly now */
      .nav-tabs .nav-link.active {
        color: var(--primary-color);
        border-bottom: 3px solid var(--primary-color);
        border-color: var(--primary-color) !important; /* Ensure border color is primary */
      }

      .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        background-color: var(--card-bg); /* Ensure cards have white background */
      }

      .total-display {
        background: var(--primary-color);
        color: white;
        padding: 12px;
        border-radius: 8px;
        font-size: 1.2rem;
      }

      .bill-item {
        display: flex;
        justify-content: space-between;
        align-items: center; /* Align items vertically */
        padding: 8px 0; /* Increased padding */
        border-bottom: 1px dashed #ccc;
      }

      .bill-item:last-child {
        border-bottom: none;
      }

      .bill-item .quantity-controls {
          display: flex;
          align-items: center;
      }

       .bill-item .quantity-controls button {
           padding: 0 6px; /* Smaller padding for quantity buttons */
           font-size: 0.8rem;
           line-height: 1; /* Adjust line height */
       }

       .bill-item .quantity-controls span {
           margin: 0 8px; /* Space between buttons and quantity */
           font-weight: bold;
       }


      /* CSS for the hidden mixed payment div */
      .hidden {
        display: none;
      }

      /* Style for low stock products */
      .low-stock {
          background-color: #fef3c7; /* Light yellow background */
      }

       /* Style for clickable table rows and sale item cards */
       .clickable-row,
       .sale-item-card {
           cursor: pointer;
           transition: background-color 0.15s ease-in-out; /* Smooth hover effect */
       }

       .clickable-row:hover {
           background-color: #e9ecef; /* Light grey on hover */
       }

       .sale-item-card:hover {
            background-color: #f1f5f9; /* Slightly darker slate 100 on hover */
       }


       /* Style for sale detail modal item list */
       #sale-detail-items .list-group-item {
           display: flex;
           justify-content: space-between;
       }

       /* Style for error messages in modal */
       .payment-error {
           color: var(--danger-color); /* Bootstrap danger color */
           font-size: 0.875em;
           margin-top: 0.25rem;
       }

       /* Style for the message area */
       #message-area {
           position: fixed; /* Fixed position */
           top: 10px; /* 10px from the top */
           right: 10px; /* 10px from the right */
           z-index: 1050; /* Above modals */
           min-width: 250px; /* Minimum width */
           max-width: 90%; /* Maximum width */
       }

       /* Style for grouping info in sale detail modal */
       .sale-detail-group {
           margin-bottom: 1rem;
           padding: 0.75rem;
           border: 1px solid var(--border-color); /* Light grey border */
           border-radius: 8px;
           background-color: var(--background-color); /* Light background */
       }

       .sale-detail-group h6 {
           margin-top: 0;
           margin-bottom: 0.5rem;
           color: var(--primary-color);
       }

        /* Style for the chart container */
       #sales-chart-container {
           position: relative; /* Needed for canvas sizing */
           height: 300px; /* Set a height for the chart */
           width: 100%; /* Make it responsive */
           /* Removed margin-top as it's now in a floating panel */
       }

       /* New Sales Tab Layout Styles */

       .sales-header {
           display: flex;
           justify-content: space-between;
           align-items: center;
           margin-bottom: 20px;
           padding-bottom: 15px;
           border-bottom: 1px solid var(--border-color);
       }

       .sales-header h5 {
           margin-bottom: 0;
           color: var(--text-color);
       }

       .sales-controls-row {
           display: flex;
           align-items: center;
           gap: 15px; /* Space between controls */
           flex-wrap: wrap; /* Allow wrapping on smaller screens */
       }

        .sales-controls-row .form-select-sm,
        .sales-controls-row .btn-sm {
            flex-shrink: 0; /* Prevent shrinking */
        }

        .sales-controls-row label {
            margin-bottom: 0; /* Remove bottom margin from label */
            font-weight: bold;
            color: var(--text-color);
        }

        .sales-summary-inline {
            display: flex;
            justify-content: space-around; /* Distribute space evenly */
            align-items: center;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 10px; /* Space between summary items on wrap */
        }

         .summary-item {
             text-align: center;
         }

         .summary-item span {
             font-size: 0.9rem;
             color: #64748b; /* Slate 500 */
         }
          .summary-item strong {
              display: block;
              font-size: 1.3rem; /* Slightly larger font for the total */
              margin-top: 5px;
              color: var(--primary-color); /* Use primary color for emphasis */
          }


          /* Floating Chart Panel Styles */
          #chart-floating-panel {
              position: fixed;
              top: 70px; /* Adjust based on navbar height */
              right: 20px;
              width: 350px; /* Fixed width for the panel */
              background-color: var(--card-bg);
              border: 1px solid var(--border-color);
              border-radius: 12px;
              box-shadow: 0 4px 8px rgba(0,0,0,0.1);
              padding: 15px;
              z-index: 1000; /* Ensure it's above main content */
              transform: translateX(400px); /* Start off-screen */
              transition: transform 0.3s ease-in-out;
          }

          #chart-floating-panel.show {
              transform: translateX(0); /* Slide in */
          }

           #chart-floating-panel .panel-header {
               display: flex;
               justify-content: space-between;
               align-items: center;
               margin-bottom: 15px;
               padding-bottom: 10px;
               border-bottom: 1px solid var(--border-color);
           }

           #chart-floating-panel .panel-header h6 {
               margin-bottom: 0;
               color: var(--primary-color);
           }

           #chart-floating-panel .panel-header .btn-close {
               padding: 0.5rem; /* Make close button easier to click */
           }


          /* Sales History List Styles (Replacing Table) */
          #sales-history-list {
              list-style: none;
              padding: 0;
              margin: 0;
              display: flex; /* Use flexbox for horizontal layout */
              flex-wrap: wrap; /* Allow items to wrap to the next line */
              gap: 15px; /* Space between cards */
          }

          .sale-item-card {
              background-color: var(--card-bg);
              border: 1px solid var(--border-color);
              border-radius: 8px;
              padding: 15px;
              /* Removed margin-bottom as gap handles spacing */
              box-shadow: 0 1px 3px rgba(0,0,0,0.05);
              flex: 1 1 300px; /* Flex properties: grow, shrink, basis */
              max-width: calc(50% - 7.5px); /* Max width for two items per row (adjust gap) */
              min-width: 300px; /* Minimum width before wrapping */
              box-sizing: border-box; /* Include padding and border in element's total width */
          }

          /* Adjust max-width for smaller screens */
           @media (max-width: 768px) {
               .sale-item-card {
                   max-width: 100%; /* Full width on small screens */
                   flex: 1 1 100%;
               }
           }


          .sale-item-header {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 10px;
              padding-bottom: 8px;
              border-bottom: 1px dashed #ccc;
          }

          .sale-item-header .sale-date {
              font-weight: bold;
              color: var(--text-color);
          }

           .sale-item-details {
               margin-bottom: 10px;
               font-size: 0.9rem;
               color: #475569; /* Slate 600 */
           }

            .sale-item-details strong {
                color: var(--text-color);
            }

            .sale-item-products {
                font-style: italic;
                margin-bottom: 10px;
            }

           /* Removed sale-item-actions as buttons are now in modal */


           /* General Button Consistency */
            .btn {
                border-radius: var(--btn-border-radius);
                transition: var(--btn-transition);
            }

            .btn-primary {
                background-color: var(--primary-color);
                border-color: var(--primary-color);
                color: white;
            }
             .btn-primary:hover {
                 background-color: var(--secondary-color);
                 border-color: var(--secondary-color);
             }

            .btn-success {
                background-color: var(--success-color);
                border-color: var(--success-color);
                color: white;
            }
             .btn-success:hover {
                 background-color: #059669; /* Darker emerald */
                 border-color: #059669;
             }

            .btn-info {
                background-color: var(--info-color);
                border-color: var(--info-color);
                color: white;
            }
             .btn-info:hover {
                 background-color: #3b82f6; /* Darker info */
                 border-color: #3b82f6;
             }

            .btn-warning {
                background-color: var(--warning-color);
                border-color: var(--warning-color);
                color: white; /* Keep text white for better contrast */
            }
             .btn-warning:hover {
                 background-color: #d97706; /* Darker amber */
                 border-color: #d97706;
             }


            .btn-danger {
                background-color: var(--danger-color);
                border-color: var(--danger-color);
                color: white;
            }
             .btn-danger:hover {
                 background-color: #b91c1c; /* Darker red */
                 border-color: #b11c1c; /* Corrected darker red border */
             }

            .btn-secondary {
                /* Using Bootstrap default secondary, or define if needed */
            }

            /* Adjust small button padding for consistency */
            .btn-sm {
                padding: calc(var(--btn-padding-y) * 0.5) calc(var(--btn-padding-x) * 0.5);
                font-size: calc(var(--btn-font-size) * 0.875);
                border-radius: var(--btn-border-radius);
            }

             /* Form Control Consistency */
             .form-control,
             .form-select {
                 border-radius: var(--btn-border-radius);
                 border-color: var(--border-color);
                 box-shadow: inset 0 1px 2px rgba(0,0,0,0.075);
             }
              .form-control:focus,
              .form-select:focus {
                  border-color: var(--primary-color);
                  box-shadow: 0 0 0 0.25rem rgba(37, 99, 235, 0.25); /* Primary color focus ring */
              }

              /* Add padding to the bottom of the sales section */
              #sales {
                  padding-bottom: 30px; /* Adjust value as needed */
              }


    </style>
  </head>
  <body>
    <div id="message-area"></div>

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="#">
          <i class="bi bi-shop-window me-2"></i>Papeler√≠a
        </a>
        <div class="d-flex align-items-center">
          <div class="exchange-rate-container bg-white p-2 rounded me-3">
            $1 =
            <input
              type="number"
              id="exchange-rate"
              value="85.40"
              step="0.01"
              style="width: 80px"
              class="form-control form-control-sm d-inline-block"
            />
            Bs
          </div>
          </div>
      </div>
    </nav>

    <div class="container-fluid mt-4">
      <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="home-tab"
            data-bs-toggle="tab"
            data-bs-target="#home"
            type="button"
            role="tab"
            aria-controls="home"
            aria-selected="true"
          >
            Principal
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="products-tab"
            data-bs-toggle="tab"
            data-bs-target="#products"
            type="button"
            role="tab"
            aria-controls="products"
            aria-selected="false"
          >
            Productos
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="sales-tab"
            data-bs-toggle="tab"
            data-bs-target="#sales"
            type="button"
            role="tab"
            aria-controls="sales"
            aria-selected="false"
          >
            Ventas
          </button>
        </li>
      </ul>

      <div class="tab-content" id="myTabContent">
        <div
          class="tab-pane fade show active"
          id="home"
          role="tabpanel"
          aria-labelledby="home-tab"
        >
          <div class="row g-4">
            <div class="col-lg-8">
              <div class="card">
                <div class="card-header bg-white">
                  <div class="d-flex justify-content-between align-items-center">
                     <h5><i class="bi bi-box-seam me-2"></i>Inventario Actual</h5>
                     <div class="col-md-4">
                         <input type="text" id="product-search" class="form-control form-control-sm" placeholder="Buscar producto...">
                     </div>
                  </div>
                </div>
                <div class="table-responsive" style="max-height: 500px">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>Producto</th>
                        <th>Precio $</th>
                        <th>Precio Bs</th>
                        <th>Existencia</th>
                        <th>Acciones</th> </tr>
                    </thead>
                    <tbody id="products-list">
                      </tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="col-lg-4">
              <div class="card h-100">
                <div class="card-header bg-white">
                  <h5><i class="bi bi-cart-check me-2"></i>Factura Actual</h5>
                </div>
                <div class="card-body">
                  <div id="current-bill-items" class="mb-3">
                    <p id="empty-bill-message" class="text-muted">
                      La factura est√° vac√≠a. Agrega productos del inventario.
                    </p>
                    </div>
                  <div class="total-display text-center mb-3">
                    Total: <span id="total-display">0.00$ | 0.00Bs</span>
                  </div>
                  <button
                    class="btn btn-primary w-100"
                    id="process-bill-button"
                    disabled >
                    <i class="bi bi-receipt-cutoff me-2"></i>Procesar Factura
                   </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div
          class="tab-pane fade"
          id="products"
          role="tabpanel"
          aria-labelledby="products-tab"
        >
          <div class="row g-4">
            <div class="col-md-4">
              <div class="card">
                <div class="card-header bg-white">
                  <h5><i class="bi bi-plus-circle me-2"></i>Nuevo Producto</h5>
                </div>
                <div class="card-body">
                  <form id="new-product-form">
                    <div class="mb-3">
                      <label for="product-name" class="form-label">Nombre del Producto</label>
                      <input
                        type="text"
                        id="product-name"
                        class="form-control"
                        placeholder="Ej: Bol√≠grafo Azul"
                        required
                      />
                    </div>
                    <div class="mb-3">
                       <label for="product-price" class="form-label">Costo en $ (Precio de compra)</label>
                      <input
                        type="number"
                        step="0.01"
                        id="product-price"
                        class="form-control"
                        placeholder="Ej: 0.50"
                        required
                        min="0"
                      />
                    </div>
                    <div class="mb-3">
                       <label for="product-stock" class="form-label">Cantidad Inicial (Stock)</label>
                      <input
                        type="number"
                        id="product-stock"
                        class="form-control"
                        placeholder="Ej: 100"
                        required
                        min="0"
                      />
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                      <i class="bi bi-save me-2"></i>Guardar Producto
                    </button>
                  </form>
                   <hr>
                   <h6><i class="bi bi-upload me-2"></i>Importar Productos (CSV)</h6>
                   <div class="mb-3">
                       <label for="csv-file-input" class="form-label">Seleccionar archivo CSV</label>
                       <input class="form-control" type="file" id="csv-file-input" accept=".csv">
                   </div>
                   <button id="import-csv-button" class="btn btn-success w-100" disabled>
                       <i class="bi bi-file-earmark-arrow-up me-2"></i>Importar desde CSV
                   </button>
                   <hr>
                   <button id="clear-storage-button" class="btn btn-danger w-100 mt-3">
                       <i class="bi bi-trash me-2"></i>Limpiar Todos los Datos
                    </button>

                </div>
              </div>
            </div>

            <div class="col-md-8">
              <div class="card">
                <div class="card-header bg-white">
                  <h5><i class="bi bi-boxes me-2"></i>Administrar Productos</h5>
                </div>
                <div class="table-responsive" style="max-height: 600px">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>Producto</th>
                        <th>Costo $</th>
                        <th>Precio Venta $</th>
                        <th>Precio Venta Bs</th>
                        <th>Existencia</th>
                        </tr>
                    </thead>
                    <tbody id="products-management-list">
                      </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div
          class="tab-pane fade"
          id="sales"
          role="tabpanel"
          aria-labelledby="sales-tab"
        >
           <div class="sales-header">
               <h5><i class="bi bi-graph-up me-2"></i>Panel de Ventas</h5>
               <div class="sales-controls-row">
                   <label for="sales-filter">Mostrar:</label>
                   <select id="sales-filter" class="form-select form-select-sm">
                       <option value="all">Todas las Ventas</option>
                       <option value="today">Ventas de Hoy</option>
                       <option value="yesterday">Ventas de Ayer</option>
                       <option value="this-week">Ventas de Esta Semana</option>
                       <option value="this-month">Ventas de Este Mes</option>
                       <option value="this-year">Ventas de Este A√±o</option>
                   </select>
                   <button id="export-sales-button" class="btn btn-secondary btn-sm me-2">
                       <i class="bi bi-file-earmark-excel me-2"></i>Exportar Ventas (CSV)
                   </button>
                    <button id="toggle-chart-panel-button" class="btn btn-info btn-sm">
                       <i class="bi bi-bar-chart me-2"></i>Mostrar Gr√°fico
                   </button>
               </div>
           </div>

           <div class="sales-summary-inline">
               <div class="summary-item">
                   <span>Total Venta Filtrado ($):</span>
                   <strong id="total-sales-usd">0.00$</strong>
               </div>
               <div class="summary-item">
                   <span>Total Venta Filtrado (Bs):</span>
                   <strong id="total-sales-bs">0.00Bs</strong>
               </div>
               <div class="summary-item">
                   <span>Total Recibido Neto Filtrado ($):</span>
                   <strong id="total-received-usd">0.00$</strong>
               </div>
               <div class="summary-item">
                   <span>Total Recibido Neto Filtrado (Bs):</span>
                   <strong id="total-received-bs">0.00Bs</strong>
               </div>
           </div>

            <div class="sales-table-section">
               <h5><i class="bi bi-list-ul me-2"></i>Historial Detallado de Ventas</h5>
               <div id="sales-history-list">
                   <p class="text-center text-muted">No hay ventas registradas.</p>
               </div>
           </div>
        </div>
      </div>
    </div>

    <div id="chart-floating-panel">
        <div class="panel-header">
            <h6>Gr√°fico de Productos M√°s Vendidos</h6>
            <button type="button" class="btn-close" aria-label="Close"></button>
        </div>
        <div id="sales-chart-container">
            <canvas id="top-products-chart"></canvas>
        </div>
    </div>


    <div
      class="modal fade"
      id="editProductModal"
      tabindex="-1"
      aria-labelledby="editProductModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="editProductModalLabel">
              <i class="bi bi-pencil-square me-2"></i>Editar Producto
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="edit-product-form">
              <input type="hidden" id="edit-product-id">
              <div class="mb-3">
                <label for="edit-product-name" class="form-label">Nombre del Producto</label>
                <input type="text" id="edit-product-name" class="form-control" required>
              </div>
              <div class="mb-3">
                 <label for="edit-product-price" class="form-label">Costo en $ (Precio de compra)</label>
                <input type="number" step="0.01" id="edit-product-price" class="form-control" required min="0">
              </div>
              <div class="mb-3">
                 <label for="edit-product-stock" class="form-label">Cantidad (Stock)</label>
                <input type="number" id="edit-product-stock" class="form-control" required min="0">
              </div>
              <button type="submit" class="btn btn-primary w-100 mb-3">
                <i class="bi bi-save me-2"></i>Guardar Cambios
              </button>
               <button type="button" class="btn btn-danger w-100" id="delete-product-from-modal">
                   <i class="bi bi-trash me-2"></i>Eliminar Producto
               </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      id="saleDetailModal"
      tabindex="-1"
      aria-labelledby="saleDetailModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="saleDetailModalLabel">
              <i class="bi bi-journal-text me-2"></i>Detalle de Venta
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
              <div class="sale-detail-group">
                  <h6>Informaci√≥n de la Venta</h6>
                  <p><strong>Fecha:</strong> <span id="sale-detail-date"></span></p>
                  <p><strong>M√©todo de Pago:</strong> <span id="sale-detail-method"></span></p>
                   <p><strong>Tasa de Cambio:</strong> <span id="sale-detail-exchange-rate"></span> Bs/$</p>
              </div>

              <div class="sale-detail-group">
                  <h6>Detalle del Pago</h6>
                   <p><strong>Monto Recibido Cliente ($):</strong> <span id="sale-detail-received-customer-usd"></span></p>
                   <p><strong>Monto Recibido Cliente (Bs):</strong> <span id="sale-detail-received-customer-bs"></span></p>
                   <p><strong>Vuelto Entregado ($):</strong> <span id="sale-detail-change-given-usd"></span></p>
                   <p><strong>Vuelto Entregado (Bs):</strong> <span id="sale-detail-change-given-bs"></span></p>
                   <p><strong>Monto Recibido Neto ($):</strong> <span id="sale-detail-received-net-usd"></span></p>
                   <p><strong>Monto Recibido Neto (Bs):</strong> <span id="sale-detail-received-net-bs"></span></p>
              </div>

               <div class="sale-detail-group">
                   <h6>Total de la Venta</h6>
                   <p><strong>Total Venta ($):</strong> <span id="sale-detail-total-usd"></span></p>
                    <p><strong>Total Venta (Bs):</strong> <span id="sale-detail-total-bs"></span></p>
               </div>


              <h6>Productos Vendidos:</h6>
              <ul id="sale-detail-items" class="list-group">
                  </ul>
          </div>
           <div class="modal-footer">
               <button type="button" class="btn btn-danger me-auto" id="delete-sale-from-modal">
                   <i class="bi bi-trash me-2"></i>Eliminar Venta
               </button>
               <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
           </div>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      id="paymentModal"
      tabindex="-1"
      aria-labelledby="paymentModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="paymentModalLabel">
              <i class="bi bi-cash-coin me-2"></i>Procesar Pago
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
                <strong>Total a Pagar:</strong>
                <span id="payment-modal-total-usd"></span>
                <span id="payment-modal-total-bs"></span>
            </div>

            <div class="mb-3">
                <label for="payment-method" class="form-label">M√©todo de Pago</label>
                <select class="form-select" id="payment-method">
                    <option value="usd">USD</option>
                    <option value="ves">VES</option>
                    <option value="mixed">Mixto</option>
                </select>
            </div>

            <div id="usd-payment-section">
                <div class="mb-3">
                    <label for="amount-received-usd" class="form-label">Monto Recibido ($)</label>
                    <input type="number" id="amount-received-usd" class="form-control" placeholder="Solo n√∫meros enteros" min="0">
                    <div id="amount-received-usd-error" class="payment-error"></div> </div>
                 <div id="usd-change-options" class="mb-3 hidden">
                    <label class="form-label">Devolver Vuelto en:</label>
                    <div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="usd-change-currency" id="usd-change-usd" value="usd" checked>
                            <label class="form-check-label" for="usd-change-usd">USD</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="usd-change-currency" id="usd-change-ves" value="ves">
                            <label class="form-check-label" for="usd-change-ves">VES</label>
                        </div>
                    </div>
                </div>
            </div>

            <div id="ves-payment-section" class="hidden">
                <div class="mb-3">
                    <label for="amount-received-ves" class="form-label">Monto Recibido (Bs)</label>
                    <input type="number" id="amount-received-ves" class="form-control" placeholder="Solo n√∫meros enteros" min="0">
                     <div id="amount-received-ves-error" class="payment-error"></div> </div>
            </div>

            <div id="mixed-payment-section" class="hidden">
                 <div class="mb-3">
                    <label for="amount-received-mixed-usd" class="form-label">Monto Recibido USD ($)</label>
                    <input type="number" id="amount-received-mixed-usd" class="form-control" placeholder="Solo n√∫meros enteros" min="0">
                     <div id="amount-received-mixed-usd-error" class="payment-error"></div> </div>
                 <div class="mb-3">
                    <label for="amount-received-mixed-ves" class="form-label">Monto Recibido VES (Bs)</label>
                    <input type="number" id="amount-received-mixed-ves" class="form-control" placeholder="Solo n√∫meros enteros" min="0">
                     <div id="amount-received-mixed-ves-error" class="payment-error"></div> </div>
            </div>

            <div id="payment-results" class="mt-4">
                <p id="payment-status"></p>
                <p id="payment-change"></p>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" id="confirm-payment-button" disabled>Confirmar Pago</button> </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Ensure JS runs after DOM is fully loaded
      document.addEventListener("DOMContentLoaded", () => {
        // --- Global State ---
        let AppState = {
          products: [], // Array to store product objects {id, name, costUSD, stock}
          sales: [],    // Array to store sale objects {date, items, totalUSD, totalBS, paymentMethod, ...}
          currentBill: [], // Array to store items currently in the bill {id, name, costUSD, quantity}
          exchangeRate: 85.40, // Default exchange rate
        };

        // --- DOM Element References ---
        const productsListTbody = document.getElementById("products-list"); // Home tab product list tbody
        const managementListTbody = document.getElementById("products-management-list"); // Products tab management list tbody
        const currentBillItemsDiv = document.getElementById("current-bill-items");
        const totalDisplaySpan = document.getElementById("total-display");
        const salesHistoryListDiv = document.getElementById('sales-history-list'); // Div for sales history list
        const newProductForm = document.getElementById("new-product-form");
        const exchangeRateInput = document.getElementById("exchange-rate");
        const emptyBillMessage = document.getElementById("empty-bill-message");
        const processBillButton = document.getElementById('process-bill-button');
        const messageArea = document.getElementById('message-area'); // Reference to the new message area

        // Filtering and Searching Elements
        const productSearchInput = document.getElementById('product-search');
        const salesFilterSelect = document.getElementById('sales-filter');


        // Edit Product Modal Elements
        const editProductModal = new bootstrap.Modal(document.getElementById('editProductModal'));
        const editProductForm = document.getElementById('edit-product-form');
        const editProductIdInput = document.getElementById('edit-product-id');
        const editProductNameInput = document.getElementById('edit-product-name');
        const editProductPriceInput = document.getElementById('edit-product-price'); // This is cost
        const editProductStockInput = document.getElementById('edit-product-stock');
        const deleteProductFromModalButton = document.getElementById('delete-product-from-modal'); // New delete button in modal

        // Sale Detail Modal Elements
        const saleDetailModal = new bootstrap.Modal(document.getElementById('saleDetailModal'));
        const saleDetailDateSpan = document.getElementById('sale-detail-date');
        const saleDetailMethodSpan = document.getElementById('sale-detail-method');
        const saleDetailExchangeRateSpan = document.getElementById('sale-detail-exchange-rate');
        const saleDetailReceivedCustomerUsdSpan = document.getElementById('sale-detail-received-customer-usd');
        const saleDetailReceivedCustomerBsSpan = document.getElementById('sale-detail-received-customer-bs');
        const saleDetailChangeGivenUsdSpan = document.getElementById('sale-detail-change-given-usd');
        const saleDetailChangeGivenBsSpan = document.getElementById('sale-detail-change-given-bs');
        const saleDetailReceivedNetUsdSpan = document.getElementById('sale-detail-received-net-usd');
        const saleDetailReceivedNetBsSpan = document.getElementById('sale-detail-received-net-bs');
        const saleDetailTotalUsdSpan = document.getElementById('sale-detail-total-usd');
        const saleDetailTotalBsSpan = document.getElementById('sale-detail-total-bs');
        const saleDetailItemsList = document.getElementById('sale-detail-items');
        const deleteSaleFromModalButton = document.getElementById('delete-sale-from-modal'); // New delete button in modal


        // Sales Report Summary Elements
        const totalSalesUsdSpan = document.getElementById('total-sales-usd');
        const totalSalesBsSpan = document.getElementById('total-sales-bs');
        const totalReceivedUsdSpan = document.getElementById('total-received-usd');
        const totalReceivedBsSpan = document.getElementById('total-received-bs');

        // Payment Modal Elements
        const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
        const paymentModalTotalUsdSpan = document.getElementById('payment-modal-total-usd');
        const paymentModalTotalBsSpan = document.getElementById('payment-modal-total-bs');
        const paymentMethodSelect = document.getElementById('payment-method');
        const usdPaymentSection = document.getElementById('usd-payment-section');
        const vesPaymentSection = document.getElementById('ves-payment-section');
        const mixedPaymentSection = document.getElementById('mixed-payment-section');
        const amountReceivedUsdInput = document.getElementById('amount-received-usd');
        const amountReceivedVesInput = document.getElementById('amount-received-ves');
        const amountReceivedMixedUsdInput = document.getElementById('amount-received-mixed-usd');
        const amountReceivedMixedVesInput = document.getElementById('amount-received-mixed-ves');
        const amountReceivedUsdError = document.getElementById('amount-received-usd-error');
        const amountReceivedVesError = document.getElementById('amount-received-ves-error');
        const amountReceivedMixedUsdError = document.getElementById('amount-received-mixed-usd-error');
        const amountReceivedMixedVesError = document.getElementById('amount-received-mixed-ves-error');
        const paymentStatusP = document.getElementById('payment-status');
        const paymentChangeP = document.getElementById('payment-change');
        const confirmPaymentButton = document.getElementById('confirm-payment-button');
        const usdChangeOptionsDiv = document.getElementById('usd-change-options');
        const usdChangeUsdRadio = document.getElementById('usd-change-usd');
        const usdChangeVesRadio = document.getElementById('usd-change-ves');

        // Export Button
        const exportSalesButton = document.getElementById('export-sales-button');

        // CSV Import Elements
        const csvFileInput = document.getElementById('csv-file-input');
        const importCsvButton = document.getElementById('import-csv-button');


        // Other Elements and Constants
        const LOW_STOCK_THRESHOLD = 5; // Threshold for highlighting low stock products
        const clearStorageButton = document.getElementById('clear-storage-button');

        // Variables to store current bill totals for the payment modal
        let currentBillTotalUSD = 0;
        let currentBillTotalBS = 0;

        // Chart elements and instance (Now in floating panel)
        const chartFloatingPanel = document.getElementById('chart-floating-panel');
        const toggleChartPanelButton = document.getElementById('toggle-chart-panel-button');
        const chartPanelCloseButton = chartFloatingPanel.querySelector('.btn-close');
        const salesChartContainer = document.getElementById('sales-chart-container');
        let topProductsChart = null;


        // --- Data Persistence ---

        // Loads data from localStorage on application start
        function loadData() {
          const savedData = localStorage.getItem("papeleriaData");
          if (savedData) {
            try {
              AppState = JSON.parse(savedData);
              // Ensure arrays exist and exchange rate is a number
              AppState.products = Array.isArray(AppState.products) ? AppState.products : [];
              AppState.sales = Array.isArray(AppState.sales) ? AppState.sales : [];
              AppState.currentBill = Array.isArray(AppState.currentBill) ? AppState.currentBill : [];
              AppState.exchangeRate = typeof AppState.exchangeRate === 'number' ? AppState.exchangeRate : 85.40;
              exchangeRateInput.value = AppState.exchangeRate.toFixed(2); // Update input display
            } catch (error) {
              console.error("Error parsing data from localStorage:", error);
              // Reset to default state if parsing fails
              AppState = { products: [], sales: [], currentBill: [], exchangeRate: 85.40 };
              localStorage.removeItem("papeleriaData"); // Clear corrupted data
              showMessage("Error al cargar los datos desde el almacenamiento local.", 'danger');
            }
          }
        }

        // Saves the current AppState to localStorage
        function saveData() {
          try {
            localStorage.setItem("papeleriaData", JSON.stringify(AppState));
          } catch (error) {
            console.error("Error saving data to localStorage:", error);
            showMessage("Error al guardar los datos. El almacenamiento local podr√≠a estar lleno.", 'danger');
          }
        }

         // --- Message Display (UI/UX Improvement) ---

        // Displays a message in the message area
        function showMessage(message, type = 'success', duration = 5000) {
            // Create a Bootstrap alert element
            const alertElement = document.createElement('div');
            alertElement.classList.add('alert', `alert-${type}`, 'alert-dismissible', 'fade', 'show');
            alertElement.setAttribute('role', 'alert');
            alertElement.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;

            // Append the alert to the message area
            messageArea.appendChild(alertElement);

            // Automatically remove the alert after a duration
            if (duration > 0) {
                setTimeout(() => {
                    const bsAlert = new bootstrap.Alert(alertElement);
                    bsAlert.close();
                }, duration);
            }
        }


        // --- Price Calculation ---

        // Calculates sale price (30% profit on cost) and converts to BS
        function calculatePrices(product) {
          const costUSD = product.costUSD;
          if (typeof costUSD !== "number" || costUSD < 0) {
            console.error("Costo inv√°lido para calcular precios:", product);
            return { priceUSD: 0, priceBS: 0, profitUSD: 0 };
          }

          const salePriceUSD = costUSD * 1.3; // 30% profit margin
          let salePriceBS = salePriceUSD * AppState.exchangeRate;

          // Round Bolivar price: up if decimal >= 0.30, down otherwise
          const decimalPart = salePriceBS % 1;
          salePriceBS = decimalPart >= 0.30 ? Math.ceil(salePriceBS) : Math.floor(salePriceBS);

          const profitUSD = salePriceUSD - costUSD; // Profit per item in USD

          return {
            priceUSD: Number(salePriceUSD.toFixed(2)), // Keep USD with 2 decimals
            priceBS: Number(salePriceBS.toFixed(0)),   // Round BS to integer
            profitUSD: Number(profitUSD.toFixed(2))    // Profit in USD
          };
        }

        // --- Rendering Functions ---

        // Renders the product list on the main tab (filtered) and management tab (all)
        function renderProducts(searchTerm = '') {
          const lowerCaseSearchTerm = searchTerm.toLowerCase();

          // Filter products for the Home tab (only show in-stock items)
          const homeFilteredProducts = AppState.products.filter(product =>
            product.stock > 0 && product.name.toLowerCase().includes(lowerCaseSearchTerm)
          );

          productsListTbody.innerHTML = homeFilteredProducts.length > 0
            ? homeFilteredProducts.map(product => {
                const prices = calculatePrices(product);
                const rowClass = product.stock <= LOW_STOCK_THRESHOLD ? 'low-stock' : ''; // Highlight low stock
                // Add data-id attribute to the row for easy access
                return `
                  <tr class="${rowClass} clickable-row" data-id="${product.id}">
                      <td>${product.name}</td>
                      <td>${prices.priceUSD.toFixed(2)}$</td>
                      <td>${prices.priceBS.toFixed(0)}Bs</td>
                      <td>${product.stock}</td>
                      <td>
                          <button class="btn btn-sm btn-primary" onclick="addToBill('${product.id}')">
                              <i class="bi bi-cart-plus"></i> Agregar
                          </button>
                      </td>
                  </tr>`;
              }).join("")
            : `<tr><td colspan="5" class="text-center text-muted">No se encontraron productos ${searchTerm ? 'con ese nombre' : ''}.</td></tr>`;


          // Render all products for the Management tab
          managementListTbody.innerHTML = AppState.products.length > 0
            ? AppState.products.map(product => {
                const prices = calculatePrices(product);
                const rowClass = product.stock <= LOW_STOCK_THRESHOLD ? 'low-stock' : ''; // Highlight low stock
                 // Add data-id attribute to the row for easy access
                return `
                  <tr class="${rowClass} clickable-row" data-id="${product.id}">
                      <td>${product.name}</td>
                      <td>${product.costUSD.toFixed(2)}$</td>
                      <td>${prices.priceUSD.toFixed(2)}$</td>
                      <td>${prices.priceBS.toFixed(0)}Bs</td>
                      <td>${product.stock}</td>
                      </tr>`;
              }).join("")
            : `<tr><td colspan="5" class="text-center text-muted">No hay productos registrados.</td></tr>`; // Adjusted colspan
        }

        // Updates the display of the current bill and its total
        function updateBillDisplay() {
          currentBillTotalUSD = 0;
          currentBillTotalBS = 0;

          if (AppState.currentBill.length === 0) {
            currentBillItemsDiv.innerHTML = `<p id="empty-bill-message" class="text-muted">La factura est√° vac√≠a. Agrega productos del inventario.</p>`;
            emptyBillMessage.style.display = 'block'; // Show empty message
          } else {
             emptyBillMessage.style.display = 'none'; // Hide empty message
             currentBillItemsDiv.innerHTML = AppState.currentBill.map(item => {
                const product = AppState.products.find(p => p.id === item.id);
                // Ensure product exists before calculating price (should always exist if added correctly)
                const prices = product ? calculatePrices(product) : { priceUSD: 0, priceBS: 0 };
                const subtotalUSD = prices.priceUSD * item.quantity;
                const subtotalBS = prices.priceBS * item.quantity;
                currentBillTotalUSD += subtotalUSD;
                currentBillTotalBS += subtotalBS;

                return `
                    <div class="bill-item">
                        <div>${item.name}</div>
                         <div class="quantity-controls">
                             <button class="btn btn-sm btn-secondary" onclick="adjustBillQuantity('${item.id}', -1)">-</button>
                             <span>${item.quantity}</span>
                             <button class="btn btn-sm btn-secondary me-2" onclick="adjustBillQuantity('${item.id}', 1)">+</button>
                             <button class="btn btn-sm btn-danger" onclick="removeFromBill('${item.id}')">
                                 <i class="bi bi-x"></i>
                             </button>
                         </div>
                        <div>${subtotalUSD.toFixed(2)}$ | ${subtotalBS.toFixed(0)}Bs</div>
                    </div>`;
              }).join("");
          }

          totalDisplaySpan.textContent = `${currentBillTotalUSD.toFixed(2)}$ | ${currentBillTotalBS.toFixed(0)}Bs`;
          checkBillAndToggleFacturarButton(); // Update button state
        }

        // Renders the sales history list based on the selected filter (Replacing Table)
        function renderSales(filterType = 'all') {
            let filteredSales = [];
            const now = new Date();
            now.setHours(0, 0, 0, 0); // Start of today

            switch (filterType) {
                case 'today':
                    filteredSales = AppState.sales.filter(sale => {
                        const saleDate = new Date(sale.date);
                        saleDate.setHours(0, 0, 0, 0);
                        return saleDate.getTime() === now.getTime();
                    });
                    break;
                case 'yesterday':
                    const yesterday = new Date(now);
                    yesterday.setDate(now.getDate() - 1);
                    filteredSales = AppState.sales.filter(sale => {
                        const saleDate = new Date(sale.date);
                        saleDate.setHours(0, 0, 0, 0);
                        return saleDate.getTime() === yesterday.getTime();
                    });
                    break;
                case 'this-week':
                    const firstDayOfWeek = new Date(now);
                    firstDayOfWeek.setDate(now.getDate() - now.getDay()); // Adjust to Sunday (or Monday if locale changes)
                     firstDayOfWeek.setHours(0, 0, 0, 0); // Ensure start of day
                    filteredSales = AppState.sales.filter(sale => {
                        const saleDate = new Date(sale.date);
                        return saleDate >= firstDayOfWeek;
                    });
                    break;
                case 'this-month':
                    const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                     firstDayOfMonth.setHours(0, 0, 0, 0); // Ensure start of day
                    filteredSales = AppState.sales.filter(sale => {
                        const saleDate = new Date(sale.date);
                        return saleDate >= firstDayOfMonth;
                    });
                    break;
                 case 'this-year':
                    const firstDayOfYear = new Date(now.getFullYear(), 0, 1);
                     firstDayOfYear.setHours(0, 0, 0, 0); // Ensure start of day
                    filteredSales = AppState.sales.filter(sale => {
                        const saleDate = new Date(sale.date);
                        return saleDate >= firstDayOfYear;
                    });
                    break;
                case 'all':
                default:
                    filteredSales = AppState.sales;
                    break;
            }

            // Calculate Sales Summary for the filtered sales
            let totalFilteredSalesUSD = 0;
            let totalFilteredSalesBS = 0;
            let totalReceivedNetUSD = 0;
            let totalReceivedNetBS = 0;

            // Aggregate product quantities for the chart
            const productSalesCount = {};
            filteredSales.forEach(sale => {
                totalFilteredSalesUSD += sale.totalUSD;
                totalFilteredSalesBS += sale.totalBS;

                const actualReceivedUSD = (sale.receivedUSD_customer || 0) - (sale.changeGivenUSD || 0);
                const actualReceivedBS = (sale.receivedBS_customer || 0) - (sale.changeGivenBS || 0);
                totalReceivedNetUSD += actualReceivedUSD;
                totalReceivedNetBS += actualReceivedBS;

                sale.items.forEach(item => {
                    if (!productSalesCount[item.name]) {
                        productSalesCount[item.name] = 0;
                    }
                    productSalesCount[item.name] += item.quantity;
                });
            });

            // Sort products by quantity sold (descending) and get top N (e.g., top 10)
            const sortedProducts = Object.entries(productSalesCount)
                .sort(([, quantityA], [, quantityB]) => quantityB - quantityA)
                .slice(0, 10); // Get top 10 products

            const topProductNames = sortedProducts.map(([name]) => name);
            const topProductQuantities = sortedProducts.map(([, quantity]) => quantity);


            // Update summary display
            totalSalesUsdSpan.textContent = `${totalFilteredSalesUSD.toFixed(2)}$`;
            totalSalesBsSpan.textContent = `${totalFilteredSalesBS.toFixed(0)}Bs`;
            totalReceivedUsdSpan.textContent = `${totalReceivedNetUSD.toFixed(2)}$`;
            totalReceivedBsSpan.textContent = `${totalReceivedNetBS.toFixed(0)}Bs`;

            // Update the chart - Now showing top products
            // Check if the floating chart panel is currently visible before updating the chart
            if (chartFloatingPanel.classList.contains('show')) {
                 updateTopProductsChart(topProductNames, topProductQuantities);
            }


            // Render the sales history list (Replacing Table)
            if (filteredSales.length === 0) {
             salesHistoryListDiv.innerHTML = `<p class="text-center text-muted">No hay ventas registradas para este per√≠odo.</p>`;
            } else {
             salesHistoryListDiv.innerHTML = filteredSales.sort((a, b) => new Date(b.date) - new Date(a.date)) // Sort descending by date
               .map(sale => {
                    // Calculate net received for this specific row display
                    const actualReceivedUSD = (sale.receivedUSD_customer || 0) - (sale.changeGivenUSD || 0);
                    const actualReceivedBS = (sale.receivedBS_customer || 0) - (sale.changeGivenBS || 0);

                    return `
                        <div class="sale-item-card" data-date="${sale.date}"> <div class="sale-item-header">
                                <span class="sale-date">${new Date(sale.date).toLocaleDateString()} ${new Date(sale.date).toLocaleTimeString()}</span>
                                </div>
                            <div class="sale-item-details">
                                <p class="mb-1"><strong>Total Venta:</strong> ${sale.totalUSD.toFixed(2)}$ | ${sale.totalBS.toFixed(0)}Bs</p>
                                <p class="mb-1"><strong>Recibido Neto:</strong> ${actualReceivedUSD.toFixed(2)}$ | ${Math.round(actualReceivedBS).toFixed(0)}Bs</p>
                                <p class="mb-1"><strong>M√©todo de Pago:</strong> ${sale.paymentMethod ? sale.paymentMethod.toUpperCase() : 'N/A'} (Tasa: ${sale.exchangeRate ? sale.exchangeRate.toFixed(2) : 'N/A'} Bs/$)</p>
                            </div>
                            <div class="sale-item-products">
                                <strong>Productos:</strong> ${sale.items.map(item => `${item.name} (x${item.quantity})`).join(", ")}
                            </div>
                        </div>
                    `;
                }).join("");
            }
        }

        // Initializes or updates the Chart.js bar chart for top selling products
        function updateTopProductsChart(productNames, quantities) {
            const ctx = document.getElementById('top-products-chart').getContext('2d');

            const data = {
                labels: productNames, // Product names on the X-axis
                datasets: [{
                    label: 'Cantidad Vendida',
                    data: quantities,
                    backgroundColor: [ /* More colors for better visual separation */
                        'rgba(37, 99, 235, 0.8)', /* primary-color */
                        'rgba(59, 130, 246, 0.8)', /* secondary-color */
                        'rgba(16, 185, 129, 0.8)', /* emerald-500 */
                        'rgba(245, 158, 11, 0.8)', /* amber-500 */
                        'rgba(239, 68, 68, 0.8)',  /* red-500 */
                        'rgba(147, 51, 234, 0.8)', /* violet-500 */
                        'rgba(236, 72, 153, 0.8)', /* pink-500 */
                        'rgba(34, 197, 94, 0.8)',  /* green-500 */
                        'rgba(249, 115, 22, 0.8)',  /* orange-500 */
                        'rgba(107, 114, 128, 0.8)' /* slate-500 */
                    ],
                    borderColor: [ /* Matching border colors */
                        'rgba(37, 99, 235, 1)',
                        'rgba(59, 130, 246, 1)',
                        'rgba(16, 185, 129, 1)',
                        'rgba(245, 158, 11, 1)',
                        'rgba(239, 68, 68, 1)',
                        'rgba(147, 51, 234, 1)',
                        'rgba(236, 72, 153, 1)',
                        'rgba(34, 197, 94, 1)',
                        'rgba(249, 115, 22, 1)',
                        'rgba(107, 114, 128, 1)'
                    ],
                    borderWidth: 1
                }]
            };

            const options = {
                 responsive: true,
                 maintainAspectRatio: false, // Allow container to control size
                 plugins: {
                    legend: {
                        display: false, // Hide legend for a single dataset bar chart
                    },
                    title: {
                        display: true,
                        text: `Productos M√°s Vendidos (${salesFilterSelect.options[salesFilterSelect.selectedIndex].text})` // Dynamic title based on filter
                    },
                     tooltip: {
                        callbacks: {
                             label: function(context) {
                                const label = context.dataset.label || '';
                                const value = context.raw;
                                return `${label}: ${value}`;
                            }
                        }
                    }
                },
                 scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Producto'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Cantidad Vendida'
                        },
                         ticks: {
                             beginAtZero: true,
                              callback: function(value) {
                                 if (Number.isInteger(value)) {
                                     return value;
                                 }
                                 return null; // Only show integer ticks
                             },
                             stepSize: 1 // Ensure steps are integers
                         }
                    }
                }
            };


            if (topProductsChart) {
                topProductsChart.destroy(); // Destroy existing chart before creating a new one
            }

             // Only create chart if there is data
            if (productNames.length > 0) {
                topProductsChart = new Chart(ctx, {
                    type: 'bar', // Use bar chart for top products
                    data: data,
                    options: options
                });
            }
        }


        // --- Product Actions ---

        // Handles the submission of the new product form
        newProductForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const name = document.getElementById("product-name").value.trim();
          const costUSD = parseFloat(document.getElementById("product-price").value);
          const stock = parseInt(document.getElementById("product-stock").value);

          // Validation
          if (!name || isNaN(costUSD) || isNaN(stock) || costUSD < 0 || stock < 0) {
              showMessage("Por favor, ingresa datos v√°lidos para el producto (Nombre no vac√≠o, Costo y Stock >= 0).", 'warning');
              return;
          }
          // Check for duplicate product name (case-insensitive)
           if (AppState.products.some(p => p.name.toLowerCase() === name.toLowerCase())) {
               showMessage(`Ya existe un producto con el nombre "${name}".`, 'warning');
               return;
           }


          const newProduct = {
            id: `prod_${Date.now()}_${Math.random().toString(36).substring(2, 7)}`, // More robust unique ID
            name: name,
            costUSD: costUSD,
            stock: stock,
          };

          AppState.products.push(newProduct);
          AppState.products.sort((a, b) => a.name.localeCompare(b.name)); // Keep products sorted alphabetically
          saveData();
          renderProducts(productSearchInput.value);
          e.target.reset(); // Clear the form
          showMessage("Producto guardado con √©xito!", 'success');
        });

        // Deletes a product after confirmation (called from modal or directly)
        window.deleteProduct = function (id) {
          const productIndex = AppState.products.findIndex(p => p.id === id);
          if (productIndex === -1) {
              console.error("Producto no encontrado para eliminar:", id);
              showMessage("Error: Producto no encontrado.", 'danger');
              return;
          }
          const productName = AppState.products[productIndex].name;

          // Check if product is in the current bill
          if (AppState.currentBill.some(item => item.id === id)) {
               showMessage(`No se puede eliminar "${productName}" porque est√° en la factura actual. Qu√≠talo de la factura primero.`, 'warning');
              return;
          }

          // Check if product exists in any sale
           const isInSales = AppState.sales.some(sale => sale.items.some(item => item.id === id));
           if (isInSales) {
               showMessage(`No se puede eliminar "${productName}" porque existe en el historial de ventas. Considera marcarlo como inactivo o con stock 0 en su lugar.`, 'warning');
               return;
           }


          if (confirm(`¬øEst√°s seguro de que deseas eliminar el producto "${productName}"? Esta acci√≥n no se puede deshacer.`)) {
              AppState.products.splice(productIndex, 1); // Remove product from array
              saveData();
              renderProducts(productSearchInput.value); // Re-render product lists
              updateBillDisplay(); // Update bill display (in case it was in bill, though check above prevents this)
              renderSales(salesFilterSelect.value); // Re-render sales with current filter
              showMessage(`Producto "${productName}" eliminado.`, 'success');
              editProductModal.hide(); // Hide the modal after deletion
          }
        };

        // Opens the edit product modal and populates it (triggered by row click)
        window.editProduct = function(id) {
            const productToEdit = AppState.products.find(p => p.id === id);
            if (!productToEdit) {
                console.error("Producto no encontrado para editar:", id);
                showMessage("Error: Producto no encontrado para editar.", 'danger');
                return;
            }

            // Populate the modal form
            editProductIdInput.value = productToEdit.id;
            editProductNameInput.value = productToEdit.name;
            editProductPriceInput.value = productToEdit.costUSD.toFixed(2); // Populate with cost, formatted
            editProductStockInput.value = productToEdit.stock;

            // Store the product ID on the delete button for easy access
            deleteProductFromModalButton.dataset.productId = productToEdit.id;

            editProductModal.show(); // Show the modal
        };

        // Handles the submission of the edit product form
        editProductForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const productId = editProductIdInput.value;
            const newName = editProductNameInput.value.trim();
            const newCostUSD = parseFloat(editProductPriceInput.value);
            const newStock = parseInt(editProductStockInput.value);

            // Validation
            if (!newName || isNaN(newCostUSD) || isNaN(newStock) || newCostUSD < 0 || newStock < 0) {
                showMessage("Por favor, ingresa datos v√°lidos para editar el producto (Nombre no vac√≠o, Costo y Stock >= 0).", 'warning');
                return;
            }

            // Check for duplicate name (excluding the current product being edited)
            if (AppState.products.some(p => p.id !== productId && p.name.toLowerCase() === newName.toLowerCase())) {
                showMessage(`Ya existe otro producto con el nombre "${newName}".`, 'warning');
                return;
            }


            // Find the product index
            const productIndex = AppState.products.findIndex(p => p.id === productId);
            if (productIndex !== -1) {
                // Update product data
                AppState.products[productIndex].name = newName;
                AppState.products[productIndex].costUSD = newCostUSD;
                AppState.products[productIndex].stock = newStock;

                AppState.products.sort((a, b) => a.name.localeCompare(b.name)); // Re-sort after name change

                saveData();
                renderProducts(productSearchInput.value); // Re-render product lists
                updateBillDisplay(); // Update bill if the edited product is in it
                renderSales(salesFilterSelect.value); // Re-render sales with current filter
                showMessage("Producto actualizado con √©xito!", 'success');
                editProductModal.hide(); // Hide the modal
            } else {
                console.error("Error al encontrar el producto para actualizar:", productId);
                showMessage("Error al actualizar el producto.", 'danger');
            }
        });

        // Event listener for the delete button inside the edit product modal
        deleteProductFromModalButton.addEventListener('click', () => {
            const productId = deleteProductFromModalButton.dataset.productId; // Get ID from data attribute
            if (productId) {
                deleteProduct(productId); // Call the delete function
            }
        });


        // --- Bill Actions ---

        // Adds a product to the current bill (exposed globally for onclick)
        window.addToBill = function (id) {
          const product = AppState.products.find((p) => p.id === id);

          if (!product) {
            console.error("Producto no encontrado para agregar a la factura:", id);
            showMessage("Error: Producto no encontrado para agregar a la factura.", 'danger');
            return;
          }

          if (product.stock <= 0) {
            showMessage(`¬°No hay m√°s ${product.name} en stock!`, 'warning');
            return;
          }

          const existingItem = AppState.currentBill.find((item) => item.id === id);

          if (existingItem) {
            existingItem.quantity++; // Increment quantity if already in bill
          } else {
            // Add new item to the bill
            AppState.currentBill.push({
              id: product.id,
              name: product.name,
              // costUSD: product.costUSD, // Store cost if needed for historical reports, but calculate price dynamically
              quantity: 1,
            });
             AppState.currentBill.sort((a, b) => a.name.localeCompare(b.name)); // Keep bill sorted
          }

          product.stock--; // Decrease stock in the main product list
          updateBillDisplay();
          renderProducts(productSearchInput.value); // Update stock display in product lists
          saveData();
        };

        // Removes an item completely from the current bill (exposed globally for onclick)
        window.removeFromBill = function(id) {
            const itemIndex = AppState.currentBill.findIndex(item => item.id === id);
            if (itemIndex !== -1) {
                const removedItem = AppState.currentBill.splice(itemIndex, 1)[0]; // Remove and get the item
                const product = AppState.products.find(p => p.id === removedItem.id);
                if (product) {
                    product.stock += removedItem.quantity; // Return the full quantity to stock
                }
                updateBillDisplay();
                renderProducts(productSearchInput.value); // Update stock display
                saveData();
            }
        };

        // Adjusts the quantity of an item in the bill (exposed globally for onclick)
        window.adjustBillQuantity = function(id, delta) { // delta is +1 or -1
            const item = AppState.currentBill.find(item => item.id === id);
            const product = AppState.products.find(p => p.id === id);

            if (!item || !product) {
                console.error("Item o producto no encontrado para ajustar cantidad:", id);
                showMessage("Error: Item o producto no encontrado.", 'danger');
                return;
            }

            const newQuantity = item.quantity + delta;

            if (delta > 0) { // Increasing quantity
                if (product.stock < delta) { // Use delta here, not 1, in case delta changes later
                    showMessage(`No hay suficiente stock de "${product.name}" para a√±adir m√°s.`, 'warning');
                    return;
                }
                item.quantity = newQuantity;
                product.stock -= delta;
            } else if (delta < 0) { // Decreasing quantity
                if (newQuantity <= 0) {
                    // If quantity reaches zero or less, remove the item completely
                    removeFromBill(id); // This handles returning stock
                    return; // Exit early as removeFromBill updates display and saves
                } else {
                    item.quantity = newQuantity;
                    product.stock -= delta; // delta is negative, so this adds stock back
                }
            }

            updateBillDisplay();
            renderProducts(productSearchInput.value); // Update stock display
            saveData();
        };

        // --- Payment Modal Logic ---

        // Opens the payment modal when "Procesar Factura" is clicked
        processBillButton.addEventListener("click", () => {
             if (AppState.currentBill.length === 0) {
                 showMessage("La factura est√° vac√≠a. Agrega productos antes de procesar.", 'warning');
                 return;
             }

             // Update modal total display using current bill totals
             paymentModalTotalUsdSpan.textContent = `$${currentBillTotalUSD.toFixed(2)}`;
             paymentModalTotalBsSpan.textContent = ` | ${currentBillTotalBS.toFixed(0)}Bs`;

             // Reset modal state
             paymentMethodSelect.value = 'usd'; // Default to USD
             amountReceivedUsdInput.value = '';
             amountReceivedVesInput.value = '';
             amountReceivedMixedUsdInput.value = '';
             amountReceivedMixedVesInput.value = '';
             paymentStatusP.textContent = '';
             paymentChangeP.textContent = '';
             usdChangeOptionsDiv.classList.add('hidden'); // Hide change options
             usdChangeUsdRadio.checked = true; // Default change currency to USD
             resetPaymentErrors(); // Clear validation errors
             confirmPaymentButton.disabled = true; // Disable confirm button initially

             togglePaymentSections('usd'); // Show the default USD section

             paymentModal.show(); // Show the modal
        });

        // Toggles visibility of payment input sections based on selected method
        function togglePaymentSections(method) {
            // Hide all sections first
            usdPaymentSection.classList.add('hidden');
            vesPaymentSection.classList.add('hidden');
            mixedPaymentSection.classList.add('hidden');
            usdChangeOptionsDiv.classList.add('hidden'); // Always hide change options when switching

            // Clear inputs and results when switching
            amountReceivedUsdInput.value = '';
            amountReceivedVesInput.value = '';
            amountReceivedMixedUsdInput.value = '';
            amountReceivedMixedVesInput.value = '';
            paymentStatusP.textContent = '';
            paymentChangeP.textContent = '';
            resetPaymentErrors();
            confirmPaymentButton.disabled = true; // Disable confirm button

            // Show the selected section
            if (method === 'usd') {
                usdPaymentSection.classList.remove('hidden');
            } else if (method === 'ves') {
                vesPaymentSection.classList.remove('hidden');
            } else if (method === 'mixed') {
                mixedPaymentSection.classList.remove('hidden');
            }
        }

        // Updates the visible payment section when the dropdown changes
        paymentMethodSelect.addEventListener('change', (e) => {
            togglePaymentSections(e.target.value);
        });

        // --- Input Validation and Calculation ---

        // Validates that input is a non-negative integer (allows empty string)
        function validateIntegerInput(inputElement, errorElement, message) {
            const value = inputElement.value;
            // Regex: Allows empty string OR one or more digits. No decimals, no negative sign.
            const isValid = value === '' || /^\d+$/.test(value);

            if (!isValid) {
                errorElement.textContent = message;
                inputElement.classList.add('is-invalid');
                return false;
            } else {
                errorElement.textContent = '';
                inputElement.classList.remove('is-invalid');
                return true;
            }
        }

        // Clears all validation error messages and styles
        function resetPaymentErrors() {
            amountReceivedUsdError.textContent = '';
            amountReceivedVesError.textContent = '';
            amountReceivedMixedUsdError.textContent = '';
            amountReceivedMixedVesError.textContent = '';
            amountReceivedUsdInput.classList.remove('is-invalid');
            amountReceivedVesInput.classList.remove('is-invalid');
            amountReceivedMixedUsdInput.classList.remove('is-invalid');
            amountReceivedMixedVesInput.classList.remove('is-invalid');
        }

        // Add input event listeners to trigger validation and recalculation
        amountReceivedUsdInput.addEventListener('input', () => {
            validateIntegerInput(amountReceivedUsdInput, amountReceivedUsdError, "Solo n√∫meros enteros positivos.");
            calculatePayment();
        });
        amountReceivedVesInput.addEventListener('input', () => {
             // Remove decimals immediately for VES
             amountReceivedVesInput.value = amountReceivedVesInput.value.replace(/\./g, '');
            validateIntegerInput(amountReceivedVesInput, amountReceivedVesError, "Solo n√∫meros enteros positivos.");
            calculatePayment();
        });
        amountReceivedMixedUsdInput.addEventListener('input', () => {
            validateIntegerInput(amountReceivedMixedUsdInput, amountReceivedMixedUsdError, "Solo n√∫meros enteros positivos.");
            calculatePayment();
        });
        amountReceivedMixedVesInput.addEventListener('input', () => {
             // Remove decimals immediately for VES
             amountReceivedMixedVesInput.value = amountReceivedMixedVesInput.value.replace(/\./g, '');
            validateIntegerInput(amountReceivedMixedVesInput, amountReceivedMixedVesError, "Solo n√∫meros enteros positivos.");
            calculatePayment();
        });

        // Recalculate payment if change currency option changes
        usdChangeUsdRadio.addEventListener('change', calculatePayment);
        usdChangeVesRadio.addEventListener('change', calculatePayment);

        // Calculates payment status (faltante/vuelto) based on inputs
        function calculatePayment() {
            const method = paymentMethodSelect.value;
            const exchangeRate = AppState.exchangeRate;
            let receivedUSD_val = 0;
            let receivedVES_val = 0;
            let isValid = true; // Assume valid initially
            let isPaymentSufficient = false; // Track if payment covers the total

            // Clear previous results and hide change options
            paymentStatusP.textContent = '';
            paymentChangeP.textContent = '';
            usdChangeOptionsDiv.classList.add('hidden');

            // --- Get received amounts, validate, and calculate status ---
            if (method === 'usd') {
                isValid = validateIntegerInput(amountReceivedUsdInput, amountReceivedUsdError, "Solo n√∫meros enteros positivos.");
                receivedUSD_val = parseInt(amountReceivedUsdInput.value) || 0;

                if (isValid && receivedUSD_val >= 0) {
                    const differenceUSD = receivedUSD_val - currentBillTotalUSD;
                    if (differenceUSD < -0.001) { // Faltante
                        paymentStatusP.textContent = `Falta: ${Math.abs(differenceUSD).toFixed(2)}$`;
                    } else {
                        isPaymentSufficient = true; // Payment is sufficient
                        if (differenceUSD > 0.001) { // Vuelto
                           paymentStatusP.textContent = 'Pago completo.';
                           usdChangeOptionsDiv.classList.remove('hidden'); // Show change options
                           const changeCurrency = document.querySelector('input[name="usd-change-currency"]:checked').value;
                           if (changeCurrency === 'usd') {
                               changeGivenUSD = parseFloat(differenceUSD.toFixed(2)); // Store change in USD
                               paymentChangeP.textContent = `Vuelto: ${changeGivenUSD.toFixed(2)}$`;
                           } else {
                               changeGivenBS = Math.round(differenceUSD * exchangeRate); // Store change in VES
                               paymentChangeP.textContent = `Vuelto: ${changeGivenBS.toFixed(0)}Bs`;
                           }
                        } else { // Pago exacto
                            paymentStatusP.textContent = 'Pago exacto.';
                        }
                    }
                }

            } else if (method === 'ves') {
                isValid = validateIntegerInput(amountReceivedVesInput, amountReceivedVesError, "Solo n√∫meros enteros positivos.");
                receivedVES_val = parseInt(amountReceivedVesInput.value) || 0;

                if (isValid && receivedVES_val >= 0) {
                    const differenceVES = receivedVES_val - currentBillTotalBS; // Direct comparison in VES

                    if (differenceVES < 0) { // Faltante
                        paymentStatusP.textContent = `Falta: ${Math.abs(differenceVES).toFixed(0)}Bs`;
                    } else {
                        isPaymentSufficient = true; // Payment is sufficient
                        if (differenceVES > 0) { // Vuelto
                           paymentStatusP.textContent = 'Pago completo.';
                           changeGivenBS = differenceVES; // Change is directly the positive difference in VES
                           paymentChangeP.textContent = `Vuelto: ${changeGivenBS.toFixed(0)}Bs`; // Change is always in VES
                        } else { // Pago exacto
                            paymentStatusP.textContent = 'Pago exacto.';
                        }
                    }
                }

            } else if (method === 'mixed') {
                const usdValid = validateIntegerInput(amountReceivedMixedUsdInput, amountReceivedMixedUsdError, "Solo n√∫meros enteros positivos.");
                const vesValid = validateIntegerInput(amountReceivedMixedVesInput, amountReceivedMixedVesError, "Solo n√∫meros enteros positivos.");
                isValid = usdValid && vesValid; // Both must be valid

                receivedUSD_val = parseInt(amountReceivedMixedUsdInput.value) || 0;
                receivedVES_val = parseInt(amountReceivedMixedVesInput.value) || 0;

                if (isValid && (receivedUSD_val >= 0 || receivedVES_val >= 0)) { // Check non-negative amounts
                    const totalReceivedEquivalentUSD = receivedUSD_val + (receivedVES_val / exchangeRate);
                    const differenceUSD = totalReceivedEquivalentUSD - currentBillTotalUSD;

                    if (differenceUSD < -0.0099) { // Faltante
                        const faltanteUSD =  Math.abs(differenceUSD);
                        const faltanteVES = parseInt(Math.round(faltanteUSD * exchangeRate));
                        paymentStatusP.textContent = `Falta: ${faltanteUSD.toFixed(2)}$ (${faltanteVES.toFixed(0)}Bs)`;
                    } else {
                        isPaymentSufficient = true; // Payment is sufficient
                        if (differenceUSD > 0.001) { // Vuelto
                            paymentStatusP.textContent = 'Pago completo.';
                            // Default to giving change in VES for mixed payments
                            changeGivenBS = Math.round(differenceUSD * exchangeRate);
                            paymentChangeP.textContent = `Vuelto: ${changeGivenBS.toFixed(0)}Bs`;
                        } else { // Pago exacto
                            paymentStatusP.textContent = 'Pago exacto.';
                        }
                    }
                }
            }

            // --- Enable/Disable Confirm Button ---
            // Enable only if input is valid AND payment is sufficient AND at least one amount is received
            const anyAmountReceived = receivedUSD_val > 0 || receivedVES_val > 0;
            confirmPaymentButton.disabled = !isValid || !isPaymentSufficient || !anyAmountReceived;

        }


        // Handles the confirmation of the payment
        confirmPaymentButton.addEventListener('click', () => {
            const method = paymentMethodSelect.value;
            let receivedUSD_customer = 0;
            let receivedBS_customer = 0;
            let changeGivenUSD = 0;
            let changeGivenBS = 0;

            // --- Determine final received amounts and calculate change based on method ---
             if (method === 'usd') {
                receivedUSD_customer = parseInt(amountReceivedUsdInput.value) || 0;
                const difference_usd = receivedUSD_customer - currentBillTotalUSD;
                if (difference_usd > 0.001) { // If change is due
                    const changeCurrency = document.querySelector('input[name="usd-change-currency"]:checked').value;
                    if (changeCurrency === 'usd') {
                        changeGivenUSD = parseFloat(difference_usd.toFixed(2)); // Keep decimals for USD change
                    } else {
                        changeGivenBS = Math.round(difference_usd * AppState.exchangeRate);
                    }
                }
            } else if (method === 'ves') {
                receivedBS_customer = parseInt(amountReceivedVesInput.value) || 0;
                const difference_ves = receivedBS_customer - currentBillTotalBS; // Direct difference in VES
                 if (difference_ves > 0) { // If change is due
                    changeGivenBS = difference_ves; // Change is directly the positive difference in VES
                 }
            } else if (method === 'mixed') {
                receivedUSD_customer = parseInt(amountReceivedMixedUsdInput.value) || 0;
                receivedBS_customer = parseInt(amountReceivedMixedVesInput.value) || 0;
                const totalReceivedEquivalentUSD = receivedUSD_customer + (receivedBS_customer / AppState.exchangeRate);
                const difference_usd = totalReceivedEquivalentUSD - currentBillTotalUSD;
                 if (difference_usd > 0.001) { // If change is due
                     // Default to giving change in VES for mixed payments
                    changeGivenBS = Math.round(difference_usd * AppState.exchangeRate);
                 }
            }


             // --- Create and store the sale record ---
             const sale = {
                 date: new Date().toISOString(), // Store date as ISO string for consistency
                 items: AppState.currentBill.map(item => {
                     const product = AppState.products.find(p => p.id === item.id);
                     const pricesAtSale = product ? calculatePrices(product) : { priceUSD: 0, priceBS: 0, profitUSD: 0 };
                     return {
                         id: item.id,
                         name: item.name,
                         quantity: item.quantity,
                         pricesAtSale: pricesAtSale, // Store calculated prices at the time of sale (includes profit)
                         costUSD: product ? product.costUSD : 0 // Also store cost at time of sale for profit calculation in reports
                     };
                 }),
                 totalUSD: currentBillTotalUSD,
                 totalBS: currentBillTotalBS,
                 paymentMethod: method,
                 receivedUSD_customer: receivedUSD_customer, // Amount customer physically gave in USD
                 receivedBS_customer: receivedBS_customer,   // Amount customer physically gave in VES
                 changeGivenUSD: changeGivenUSD,             // Change given back in USD (ensure integer for display if needed)
                 changeGivenBS: Math.round(changeGivenBS),   // Change given back in VES (ensure integer)
                 exchangeRate: AppState.exchangeRate         // Exchange rate at the time of sale
             };

             AppState.sales.push(sale);
             AppState.currentBill = []; // Clear the current bill
             saveData();

             // --- Update UI ---
             updateBillDisplay(); // Update bill display (will show empty)
             renderSales(salesFilterSelect.value); // Update sales history with current filter
             renderProducts(productSearchInput.value); // Update product stock display (already updated during bill modification)

             paymentModal.hide(); // Hide the payment modal
             showMessage("Factura procesada con √©xito!", 'success');
        });


        // Enables/Disables the "Procesar Factura" button based on whether the bill has items
        function checkBillAndToggleFacturarButton() {
             processBillButton.disabled = AppState.currentBill.length === 0;
        }

        // --- Sale Detail Logic ---

        // Displays details of a specific sale in a modal (triggered by card click)
        window.viewSaleDetail = function(saleDateISOString) {
            const sale = AppState.sales.find(s => s.date === saleDateISOString);
            if (!sale) {
                console.error("Venta no encontrada:", saleDateISOString);
                showMessage("Error: Venta no encontrada.", 'danger');
                return;
            }

            // Populate modal fields
            saleDetailDateSpan.textContent = new Date(sale.date).toLocaleString('es-VE'); // Format date/time
            saleDetailMethodSpan.textContent = sale.paymentMethod ? sale.paymentMethod.toUpperCase() : 'N/A';
            saleDetailExchangeRateSpan.textContent = sale.exchangeRate ? sale.exchangeRate.toFixed(2) : 'N/A';

            // Display amounts exactly as stored (what customer gave, what change was given)
            saleDetailReceivedCustomerUsdSpan.textContent = `${(sale.receivedUSD_customer || 0).toFixed(0)}$`;
            saleDetailReceivedCustomerBsSpan.textContent = `${(sale.receivedBS_customer || 0).toFixed(0)}Bs`;
            // Ensure changeGivenBS is displayed as integer
            saleDetailChangeGivenUsdSpan.textContent = `${(sale.changeGivenUSD || 0).toFixed(2)}$`;
            saleDetailChangeGivenBsSpan.textContent = `${Math.round(sale.changeGivenBS || 0).toFixed(0)}Bs`;


            // Calculate and display net received
            const actualReceivedUSD = (sale.receivedUSD_customer || 0) - (sale.changeGivenUSD || 0);
            const actualReceivedBS = (sale.receivedBS_customer || 0) - (sale.changeGivenBS || 0);
            // Ensure net received BS is displayed as integer
            saleDetailReceivedNetUsdSpan.textContent = `${actualReceivedUSD.toFixed(2)}$`;
            saleDetailReceivedNetBsSpan.textContent = `${Math.round(actualReceivedBS).toFixed(0)}Bs`;

            saleDetailTotalUsdSpan.textContent = `${sale.totalUSD.toFixed(2)}$`;
            saleDetailTotalBsSpan.textContent = `${sale.totalBS.toFixed(0)}Bs`;


            // Populate item list using prices stored at the time of sale
            saleDetailItemsList.innerHTML = sale.items.map(item => {
                const itemTotalUSD = (item.pricesAtSale?.priceUSD || 0) * item.quantity;
                const itemTotalBS = (item.pricesAtSale?.priceBS || 0) * item.quantity;
                return `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>${item.name} (x${item.quantity})</span>
                        <span class="badge bg-light text-dark rounded-pill">${itemTotalUSD.toFixed(2)}$ | ${itemTotalBS.toFixed(0)}Bs</span>
                    </li>
                `;
            }).join('');

            // Store the sale date on the delete button for easy access
            deleteSaleFromModalButton.dataset.saleDate = sale.date;


            saleDetailModal.show(); // Show the modal
        };

         // Deletes a sale and returns items to stock (called from modal or directly)
        window.deleteSale = function(saleDateISOString) {
            const saleIndex = AppState.sales.findIndex(s => s.date === saleDateISOString);
            if (saleIndex === -1) {
                console.error("Venta no encontrada para eliminar:", saleDateISOString);
                showMessage("Error: Venta no encontrada para eliminar.", 'danger');
                return;
            }

            if (confirm(`¬øEst√°s seguro de que deseas eliminar esta venta (${new Date(saleDateISOString).toLocaleString()})? Los productos ser√°n devueltos al inventario.`)) {
                const deletedSale = AppState.sales.splice(saleIndex, 1)[0]; // Remove and get the sale

                // Return items to stock
                deletedSale.items.forEach(item => {
                    const product = AppState.products.find(p => p.id === item.id);
                    if (product) {
                        product.stock += item.quantity;
                    } else {
                        console.warn(`Producto con ID ${item.id} no encontrado en el inventario al eliminar la venta. No se pudo devolver el stock.`);
                        // Optionally log this or show a specific message
                         showMessage(`Advertencia: Producto "${item.name}" no encontrado en inventario. No se pudo devolver el stock.`, 'warning');
                    }
                });

                saveData();
                renderSales(salesFilterSelect.value); // Re-render sales history with current filter
                renderProducts(productSearchInput.value); // Update product stock display
                showMessage("Venta eliminada y stock devuelto.", 'success');
                saleDetailModal.hide(); // Hide the modal after deletion
            }
        };

        // Event listener for the delete button inside the sale detail modal
        deleteSaleFromModalButton.addEventListener('click', () => {
            const saleDate = deleteSaleFromModalButton.dataset.saleDate; // Get date from data attribute
            if (saleDate) {
                deleteSale(saleDate); // Call the delete function
            }
        });


        // --- Data Export Functions ---

        // Helper function to escape CSV fields that contain commas or quotes
        function escapeCsvField(field) {
            if (typeof field === 'string' && (field.includes(',') || field.includes('"') || field.includes('\n'))) {
                // Replace double quotes with two double quotes, then wrap in double quotes
                return `"${field.replace(/"/g, '""')}"`;
            }
             // Convert numbers to string and handle potential null/undefined
            if (field === null || field === undefined) return '';
            return String(field);
        }

        // Generates and downloads a CSV file
        function downloadCsv(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) { // Feature detection
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url); // Clean up
            } else {
                // Fallback for browsers that don't support download attribute
                showMessage("Tu navegador no soporta la descarga autom√°tica. Por favor, copia el contenido manualmente.", 'warning');
                console.log(csvContent); // Log content to console
            }
        }

        // Exports sales data to CSV based on the currently applied filter date
        exportSalesButton.addEventListener('click', () => {
             const filterType = salesFilterSelect.value;
             let salesToExport = [];
             const now = new Date();
             now.setHours(0, 0, 0, 0);

             // Re-apply filter logic to get the correct sales subset for export
             switch (filterType) {
                case 'today':
                    salesToExport = AppState.sales.filter(sale => {
                        const saleDate = new Date(sale.date);
                        saleDate.setHours(0, 0, 0, 0);
                        return saleDate.getTime() === now.getTime();
                    });
                    break;
                case 'yesterday':
                    const yesterday = new Date(now);
                    yesterday.setDate(now.getDate() - 1);
                     salesToExport = AppState.sales.filter(sale => {
                        const saleDate = new Date(sale.date);
                        saleDate.setHours(0, 0, 0, 0);
                        return saleDate.getTime() === yesterday.getTime();
                    });
                    break;
                case 'this-week':
                    const firstDayOfWeek = new Date(now);
                    firstDayOfWeek.setDate(now.getDate() - now.getDay()); // Adjust to Sunday (or Monday)
                     firstDayOfWeek.setHours(0, 0, 0, 0);
                     salesToExport = AppState.sales.filter(sale => {
                        const saleDate = new Date(sale.date);
                        return saleDate >= firstDayOfWeek;
                    });
                    break;
                case 'this-month':
                    const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                     firstDayOfMonth.setHours(0, 0, 0, 0);
                     salesToExport = AppState.sales.filter(sale => {
                        const saleDate = new Date(sale.date);
                        return saleDate >= firstDayOfMonth;
                    });
                    break;
                 case 'this-year':
                    const firstDayOfYear = new Date(now.getFullYear(), 0, 1);
                     firstDayOfYear.setHours(0, 0, 0, 0);
                     salesToExport = AppState.sales.filter(sale => {
                        const saleDate = new Date(sale.date);
                        return saleDate >= firstDayOfYear;
                    });
                    break;
                case 'all':
                default:
                    salesToExport = AppState.sales;
                    break;
             }


            if (salesToExport.length === 0) {
                showMessage("No hay ventas para exportar en el per√≠odo seleccionado.", 'info');
                return;
            }

            const header = [
                "Fecha", "Productos", "Cantidad Total", "Total Venta ($)", "Total Venta (Bs)",
                "M√©todo de Pago", "Tasa Cambio", "Recibido Cliente ($)", "Recibido Cliente (Bs)",
                "Vuelto Entregado ($)", "Vuelto Entregado (Bs)", "Recibido Neto ($)", "Recibido Neto (Bs)",
                "Ganancia Estimada ($)" // Added profit column
            ];

            const rows = salesToExport.map(sale => {
                 const itemsSummary = sale.items.map(item => `${item.name} (x${item.quantity})`).join("; "); // Use semicolon for item separation within cell
                 const totalQuantity = sale.items.reduce((sum, item) => sum + item.quantity, 0);
                 const actualReceivedUSD = (sale.receivedUSD_customer || 0) - (sale.changeGivenUSD || 0);
                 const actualReceivedBS = (sale.receivedBS_customer || 0) - (sale.changeGivenBS || 0);

                 // Calculate profit for this sale row
                 let saleProfitUSD = 0;
                 sale.items.forEach(item => {
                     const itemCostUSD = item.costUSD !== undefined ? item.costUSD : (AppState.products.find(p => p.id === item.id)?.costUSD || 0);
                     const itemSalePriceUSD = item.pricesAtSale?.priceUSD || 0;
                     saleProfitUSD += (itemSalePriceUSD - itemCostUSD) * item.quantity;
                 });


                return [
                    escapeCsvField(new Date(sale.date).toLocaleString('es-VE')),
                    escapeCsvField(itemsSummary),
                    escapeCsvField(totalQuantity),
                    escapeCsvField(sale.totalUSD.toFixed(2)),
                    escapeCsvField(sale.totalBS.toFixed(0)),
                    escapeCsvField(sale.paymentMethod ? sale.paymentMethod.toUpperCase() : 'N/A'),
                    escapeCsvField(sale.exchangeRate ? sale.exchangeRate.toFixed(2) : 'N/A'),
                    escapeCsvField((sale.receivedUSD_customer || 0).toFixed(0)),
                    escapeCsvField((sale.receivedBS_customer || 0).toFixed(0)),
                    escapeCsvField((sale.changeGivenUSD || 0).toFixed(2)),
                    escapeCsvField(Math.round(sale.changeGivenBS || 0).toFixed(0)),
                    escapeCsvField(actualReceivedUSD.toFixed(2)),
                    escapeCsvField(Math.round(actualReceivedBS).toFixed(0)),
                    escapeCsvField(saleProfitUSD.toFixed(2)) // Add profit to CSV row
                ].join(',');
            });

            const csvContent = [header.join(','), ...rows].join('\n');
            const filename = `ventas_papeleria_export_${filterType || 'todas'}_${new Date().toISOString().slice(0,10)}.csv`; // Dynamic filename
            downloadCsv(csvContent, filename);
            showMessage("Ventas exportadas a CSV.", 'success');
        });


        // --- CSV Import Functionality ---

        // Enable the import button when a file is selected
        csvFileInput.addEventListener('change', (event) => {
            if (event.target.files.length > 0) {
                importCsvButton.disabled = false;
            } else {
                importCsvButton.disabled = true;
            }
        });

        // Handle the CSV import button click
        importCsvButton.addEventListener('click', () => {
            const file = csvFileInput.files[0];
            if (!file) {
                showMessage("Por favor, selecciona un archivo CSV.", 'warning');
                return;
            }

            const reader = new FileReader();

            reader.onload = (event) => {
                const csvContent = event.target.result;
                processCsvData(csvContent);
            };

            reader.onerror = () => {
                showMessage("Error al leer el archivo CSV.", 'danger');
            };

            reader.readAsText(file); // Read the file as text
        });

        // Process the CSV data
        function processCsvData(csvContent) {
            const lines = csvContent.split('\n').filter(line => line.trim() !== ''); // Split into lines and remove empty ones
            let addedCount = 0;
            let updatedCount = 0;
            let skippedCount = 0;

            if (lines.length === 0) {
                showMessage("El archivo CSV est√° vac√≠o.", 'info');
                return;
            }

            // Simple CSV parsing: assuming format "Nombre,Costo,Existencia"
            lines.forEach((line, index) => {
                const columns = line.split(',');

                // Basic validation: check if there are 3 columns
                if (columns.length !== 3) {
                    console.warn(`Fila ${index + 1} saltada: N√∫mero incorrecto de columnas (${columns.length}).`);
                    skippedCount++;
                    return; // Skip this row
                }

                const name = columns[0].trim();
                const costUSD = parseFloat(columns[1].trim());
                const stock = parseInt(columns[2].trim());

                // Validate data types and values
                if (!name || isNaN(costUSD) || isNaN(stock) || costUSD < 0 || stock < 0) {
                     console.warn(`Fila ${index + 1} saltada: Datos inv√°lidos (Nombre: "${name}", Costo: ${columns[1]}, Stock: ${columns[2]}).`);
                    skippedCount++;
                    return; // Skip this row
                }

                // Check if product with the same name already exists (case-insensitive)
                const existingProductIndex = AppState.products.findIndex(p => p.name.toLowerCase() === name.toLowerCase());

                if (existingProductIndex !== -1) {
                    // Product exists, update cost and stock
                    AppState.products[existingProductIndex].costUSD = costUSD;
                    AppState.products[existingProductIndex].stock = stock;
                    updatedCount++;
                } else {
                    // Product does not exist, add as new
                    const newProduct = {
                        id: `prod_${Date.now()}_${Math.random().toString(36).substring(2, 7)}`, // Unique ID
                        name: name,
                        costUSD: costUSD,
                        stock: stock,
                    };
                    AppState.products.push(newProduct);
                    addedCount++;
                }
            });

            AppState.products.sort((a, b) => a.name.localeCompare(b.name)); // Keep products sorted
            saveData();
            renderProducts(productSearchInput.value); // Re-render UI

            // Show summary message
            showMessage(`Importaci√≥n de CSV completada: ${addedCount} productos a√±adidos, ${updatedCount} productos actualizados, ${skippedCount} filas saltadas.`, 'success');

            // Reset file input
            csvFileInput.value = '';
            importCsvButton.disabled = true;
        }


        // --- General Event Listeners ---

        // Updates exchange rate and recalculates prices when input changes
        exchangeRateInput.addEventListener("input", (e) => {
          const newRate = parseFloat(e.target.value);
          if (!isNaN(newRate) && newRate > 0) {
            AppState.exchangeRate = newRate;
            saveData();
            // Re-render affected parts of the UI
            renderProducts(productSearchInput.value);
            updateBillDisplay();
            renderSales(salesFilterSelect.value); // Re-render sales with current filter
            // No need to re-render cash closing report automatically, user will generate it
            showMessage("Tasa de cambio actualizada.", 'info', 3000); // Short duration message
          } else {
              // Provide feedback without alert if possible, maybe input validation styling
              // console.warn("Tasa de cambio inv√°lida ingresada.");
              // Optionally reset to the last valid rate if input becomes invalid
              // e.target.value = AppState.exchangeRate.toFixed(2);
              showMessage("Por favor, ingresa una tasa de cambio v√°lida.", 'warning', 3000);
          }
        });
         // Prevent non-numeric input in exchange rate
         exchangeRateInput.addEventListener("keypress", (e) => {
            if (!/[0-9.]/.test(e.key) && e.key !== 'Backspace' && e.key !== 'Delete' && e.key !== 'ArrowLeft' && e.key !== 'ArrowRight' && e.key !== 'Tab') {
                e.preventDefault();
            }
        });


        // Filters the product list on the Home tab as the user types
        productSearchInput.addEventListener('input', (e) => {
            renderProducts(e.target.value);
        });

        // Filters the sales history when the filter select changes
        salesFilterSelect.addEventListener('change', (e) => {
            renderSales(e.target.value);
            showMessage(`Filtro de ventas cambiado a "${e.target.options[e.target.selectedIndex].text}".`, 'info', 3000);
        });

        // Toggle the floating chart panel
        toggleChartPanelButton.addEventListener('click', () => {
            chartFloatingPanel.classList.toggle('show');
            // If the panel is shown, update the chart
            if (chartFloatingPanel.classList.contains('show')) {
                 renderSales(salesFilterSelect.value); // This will trigger chart update if visible
            } else {
                 // Destroy chart when hidden
                 if (topProductsChart) {
                     topProductsChart.destroy();
                     topProductsChart = null;
                 }
            }
        });

        // Close button for the floating chart panel
         chartPanelCloseButton.addEventListener('click', () => {
            chartFloatingPanel.classList.remove('show');
             // Destroy chart when hidden
             if (topProductsChart) {
                 topProductsChart.destroy();
                 topProductsChart = null;
             }
         });


        // Clears all data from localStorage after confirmation
        if (clearStorageButton) {
            clearStorageButton.addEventListener('click', () => {
                if (confirm('ADVERTENCIA: ¬øEst√°s ABSOLUTAMENTE seguro de que deseas eliminar TODOS los datos (productos, ventas, factura actual)? Esta acci√≥n es irreversible.')) {
                    if (confirm('CONFIRMACI√ìN FINAL: Eliminar todos los datos permanentemente.')) {
                        localStorage.clear();
                        // Reset AppState in memory to default
                        AppState = {
                            products: [],
                            sales: [],
                            currentBill: [],
                            exchangeRate: 85.40, // Reset to default rate
                        };
                        // Re-render the entire UI to reflect the empty state
                        renderProducts();
                        renderSales();
                        updateBillDisplay();
                        exchangeRateInput.value = AppState.exchangeRate.toFixed(2);
                        productSearchInput.value = ''; // Clear search
                        salesFilterSelect.value = 'all'; // Reset sales filter
                        // Destroy chart if it exists
                        if(topProductsChart) {
                           topProductsChart.destroy();
                           topProductsChart = null;
                        }
                         // Hide the floating chart panel on clear data
                         chartFloatingPanel.classList.remove('show');

                        showMessage('Todos los datos han sido eliminados permanentemente.', 'success');
                    }
                }
            });
        }

        // --- Event Delegation for Clickable Rows/Cards ---

        // Event listener for clicks on the product lists (Home and Products tabs)
        // Use event delegation on the tbody
        productsListTbody.addEventListener('click', handleProductRowClick);
        managementListTbody.addEventListener('click', handleProductRowClick);

        function handleProductRowClick(event) {
            // Find the closest row (<tr>) that was clicked
            const row = event.target.closest('tr.clickable-row');
            if (row) {
                const productId = row.dataset.id; // Get the product ID from the data attribute
                 // Check if the click was on the "Agregar" button in the home tab
                const addButton = event.target.closest('button.btn-primary');
                 if (addButton && row.parentElement.id === 'products-list') {
                     // If it was the add button in the home list, let that click handler run
                     // The onclick attribute on the button will handle this
                     return;
                 }

                // Otherwise, open the edit modal
                if (productId) {
                    editProduct(productId); // Call the edit function
                }
            }
        }


        // Event listener for clicks on the sales history list (Sales tab)
        // Use event delegation on the sales history list div
        salesHistoryListDiv.addEventListener('click', (event) => {
            // Find the closest sale item card (div.sale-item-card) that was clicked
            const saleCard = event.target.closest('.sale-item-card');
            if (saleCard) {
                const saleDate = saleCard.dataset.date; // Get the sale date from the data attribute
                if (saleDate) {
                    viewSaleDetail(saleDate); // Call the view sale detail function
                }
            }
        });


        // --- Initial Application Load ---
        loadData(); // Load data from localStorage
        renderProducts(); // Render initial product lists
        renderSales(salesFilterSelect.value); // Render initial sales history with default filter ('all')
        updateBillDisplay(); // Render initial bill state
        checkBillAndToggleFacturarButton(); // Set initial state of the process button

      }); // End DOMContentLoaded
    </script>
  </body>
</html>
